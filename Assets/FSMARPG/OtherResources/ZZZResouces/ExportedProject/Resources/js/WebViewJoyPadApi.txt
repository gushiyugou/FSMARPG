
var on_mihoyo_sdk_joypad_button_pressed;
var mihoyo_sdk_webview_on_foreground = true;
var mihoyo_sdk_joypad_rAF = window.mozRequestAnimationFrame ||
  window.webkitRequestAnimationFrame ||
  window.requestAnimationFrame;

var mihoyo_sdk_joypad_rAFStop = window.mozCancelAnimationFrame ||
  window.webkitCancelAnimationFrame ||
  window.cancelAnimationFrame;

var mihoyo_sdk_joypad_start = 0;

const mihoyo_sdk_joypad_btn_status = [false, false, false, false];
const mihoyo_sdk_joypad_layout_1 = [2, 0, 1, 3];
var mihoyo_sdk_joypad_layout_is_standard = true;

window.addEventListener("gamepadconnected", function () {
    var connectedGamepad = mihoyo_sdk_getFirstConnectedGamepad();
    if (!connectedGamepad) return;
    mihoyo_sdk_joypad_layout_is_standard = (connectedGamepad.mapping == "standard");
  mihoyo_sdk_gameLoop();
});

window.addEventListener("gamepaddisconnected", function () {
    mihoyo_sdk_joypad_rAFStop(mihoyo_sdk_joypad_start);
});

if(!('GamepadEvent' in window)) {
  var interval = setInterval(mihoyo_sdk_pollGamepads, 500);
}

function mihoyo_sdk_getFirstConnectedGamepad() {
    var gamepads = navigator.getGamepads ? navigator.getGamepads() : (navigator.webkitGetGamepads ? navigator.webkitGetGamepads : []);
    if (!gamepads) return null;
    
    for (var i = 0; i < gamepads.length; i++) {
        if (gamepads[i]) {
            return gamepads[i];
        }
    }
    return null;
}

function mihoyo_sdk_joypad_mapping_btn_index(indexV) {
    if (mihoyo_sdk_joypad_layout_is_standard) {
        return indexV;
    }
    return mihoyo_sdk_joypad_layout_1[indexV];
}

function mihoyo_sdk_set_webview_foreground(val) {
    mihoyo_sdk_webview_on_foreground = val;
    if (val) {

        mihoyo_sdk_joypad_start = mihoyo_sdk_joypad_rAF(mihoyo_sdk_gameLoop);
    }
    else {
        mihoyo_sdk_joypad_btn_status[0] = true;
        mihoyo_sdk_joypad_btn_status[1] = true;
        mihoyo_sdk_joypad_btn_status[2] = true;
        mihoyo_sdk_joypad_btn_status[3] = true;

        mihoyo_sdk_joypad_rAFStop(mihoyo_sdk_joypad_start);

    }
}

function mihoyo_sdk_pollGamepads() {
  var gp = mihoyo_sdk_getFirstConnectedGamepad();
  if (gp) {
    mihoyo_sdk_gameLoop();
    clearInterval(interval);
  }
}
function mihoyo_sdk_buttonPressed(b, index) {
    if (typeof (b) == "object") {
        if (mihoyo_sdk_joypad_btn_status[index] == false && b.pressed) {
            mihoyo_sdk_joypad_btn_status[index] = true;
            return b.pressed;
        }
        if (!b.pressed) {
            mihoyo_sdk_joypad_btn_status[index] = false;
        }
        return false;
  }
    return b == 1.0;
}

function mihoyo_sdk_gameLoop() {
    var gp = mihoyo_sdk_getFirstConnectedGamepad();
    if (gp && gp.buttons) {
        mihoyo_sdk_joypad_layout_is_standard = (gp.mapping == "standard");
        if (mihoyo_sdk_buttonPressed(gp.buttons[0], 0)) {
            on_mihoyo_sdk_joypad_button_pressed(mihoyo_sdk_joypad_mapping_btn_index(0));
        } else if (mihoyo_sdk_buttonPressed(gp.buttons[2], 2)) {
            on_mihoyo_sdk_joypad_button_pressed(mihoyo_sdk_joypad_mapping_btn_index(2));
        }
        if (mihoyo_sdk_buttonPressed(gp.buttons[1], 1)) {
            on_mihoyo_sdk_joypad_button_pressed(mihoyo_sdk_joypad_mapping_btn_index(1));
        } else if (mihoyo_sdk_buttonPressed(gp.buttons[3], 3)) {
            on_mihoyo_sdk_joypad_button_pressed(mihoyo_sdk_joypad_mapping_btn_index(3));
        }
    } else {
        return;
    }

    mihoyo_sdk_joypad_start = mihoyo_sdk_joypad_rAF(mihoyo_sdk_gameLoop);
};